

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Umbrella Sampling &#8212; Advanced Thermodynamics for Chemical Engineers</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/defs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lecture_files/Lecture14B';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Free energy perturbation and thermodynamic integration" href="Lecture15.html" />
    <link rel="prev" title="The potential of mean force" href="Lecture14A.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    <p class="title logo__title">Advanced Thermodynamics for Chemical Engineers</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Class introduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Statistical Mechanics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Lecture1A.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture1B.html">Review of thermodynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture2.html">Postulates of statistical mechanics</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture3.html">Application of the microcanonical ensemble: two-state system</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture4.html">The canonical ensemble</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture5.html">Generalized ensembles</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture6.html">The ideal gas partition function</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture7.html">Application of independent subsystems: the Langmuir isotherm</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture8A.html">The Ising model</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture8B.html">Mean-field theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture9A.html">Fluctuations and thermodynamic response functions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Molecular Simulation</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Lecture9B.html">An introduction to molecular simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture10.html">Monte Carlo simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture11.html">Nuances of stochastic sampling in statistical ensembles</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture12A.html">Molecular dynamics simulations</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture12B.html">Temperature and velocities in MD</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture13.html">Distribution of particles in states of matter</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture14A.html">The potential of mean force</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Umbrella Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture15.html">Free energy perturbation and thermodynamic integration</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Thermodynamics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="Lecture16.html">Postulates of thermodynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lecture17.html">Heat engines and possible processes</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Problem Sets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../problems/ps_1/problem_set_1.html">Problem Set 1 (Due Tuesday, September 19, 2023)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../problems/ps_2/problem_set_2.html">Problem Set 2 (Due Thursday, September 28, 2023)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../problems/ps_3/problem_set_3.html">Problem Set 3 (Due Thursday, October 10, 2023)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../problems/simulation_project.html">Simulation Project (Due Tuesday, November 14, 2023)</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../notation.html">Additional Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">Bibliography</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/lecture_files/Lecture14B.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Umbrella Sampling</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-readings-for-the-enthusiast">Additional Readings for the Enthusiast</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#goals-for-today-s-lecture">Goals for Today’s Lecture</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Umbrella sampling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#relating-the-biased-probability-distribution-to-the-unbiased-one">Relating the biased probability distribution to the unbiased one</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#link-to-shared-notes">Link to Shared Notes</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="umbrella-sampling">
<h1>Umbrella Sampling<a class="headerlink" href="#umbrella-sampling" title="Permalink to this headline">#</a></h1>
<section id="additional-readings-for-the-enthusiast">
<h2>Additional Readings for the Enthusiast<a class="headerlink" href="#additional-readings-for-the-enthusiast" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p><span id="id1">Frenkel and Smit [<a class="reference internal" href="../references.html#id5" title="Daan Frenkel and Berend Smit. Understanding molecular simulation: from algorithms to applications. Number 1 in Computational science series. Academic Press, San Diego, 2nd ed edition, 2002. ISBN 978-0-12-267351-1. URL: https://www.eng.uc.edu/~beaucag/Classes/AdvancedMaterialsThermodynamics/Books/%5BComputational%20science%20(San%20Diego,%20Calif.)%5D%20Daan%20Frenkel_%20Berend%20Smit%20-%20Understanding%20molecular%20simulation%20_%20from%20algorithms%20to%20applications%20(2002,%20Academic%20Press%20)%20-%20libgen.lc.pdf.">2</a>]</span>, Ch. 7.4</p></li>
</ul>
</section>
<section id="goals-for-today-s-lecture">
<h2>Goals for Today’s Lecture<a class="headerlink" href="#goals-for-today-s-lecture" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Understand how to bias simulations towards coordinates of interest</p></li>
<li><p>Relate biased probability distributions to unbiased ones</p></li>
</ul>
</section>
<section id="id2">
<h2><a class="reference external" href="https://en.wikipedia.org/wiki/Umbrella_sampling">Umbrella sampling</a><a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h2>
<p>The PMF is a very useful quantity for calculating equilibrium free
energy changes associated with processes that involve a well-defined
reaction coordinate. To calculate the PMF, however, the probability
associated with a specific value of the reaction coordinate, <span class="math notranslate nohighlight">\(p(x')\)</span>,
must be determined.</p>
<p>In principle, this probability distribution could be
calculated by simply generating system configurations within the entire
accessible phase space (using either standard molecular dynamics with
correct thermostatting or via Monte Carlo sampling, for example) and
calculating how frequently the desired values of the reaction coordinate
are observed.</p>
<div class="admonition-what-are-some-drawbacks-of-stochastically-sampling-the-phase-space-to-analyze-reaction-coordinates admonition">
<p class="admonition-title">What are some drawbacks of stochastically sampling the phase space to analyze reaction coordinates?</p>
<details><summary> Click for answer </summary>
<ol class="arabic simple">
<li><p>This brute force approach is very unlikely to
sample states efficiently, as the vast majority of simulation time would
be spent computing configurations for the high-probability values of
<span class="math notranslate nohighlight">\(x'\)</span>.</p></li>
<li><p>If any value of the reaction coordinate exists in a region
of phase space that is nearly inaccessible (<em>i.e.</em>, the reaction
coordinate sits at the top of a free energy barrier), then it is likely
that the value may never be determined via a brute force approach, and
therefore the free energy cannot be accurately sampled.</p></li>
</ol>
<p><img alt="image" src="../_images/fig_14_2-01.png" /></p>
</details>
</div>
<p>One solution to overcome the sampling problem and facilitate the
calculation of the probability densities of interest (and thus the PMF)
is to apply a <strong>bias</strong> to the system dynamics - that is, apply
unphysical forces that will enforce sampling of desired values of
reaction coordinate. In one popular technique, known as</p>
<dl class="glossary simple">
<dt id="term-umbrella-sampling">umbrella sampling<a class="headerlink" href="#term-umbrella-sampling" title="Permalink to this term">#</a></dt><dd><p>an advanced sampling technique where a set of weight functions are defined and added to the
system potential energy function.</p>
</dd>
</dl>
<p>Consider the case where we want to sample a system near <span class="math notranslate nohighlight">\(x\)</span>. For an
independent simulation <span class="math notranslate nohighlight">\(i\)</span>, we define
<span class="math notranslate nohighlight">\(w_i(x) \equiv w_i[x(\mathbf{r}^N)]\)</span> as the weight function about x;
conventionally, the weight function is harmonic
(although other functional forms are reasonable) such that :</p>
<div class="math notranslate nohighlight">
\[\begin{aligned}
w_i(x) &amp;= \frac{1}{2} k (x - x_i)^2
\end{aligned}\]</div>
<p>where <span class="math notranslate nohighlight">\(k\)</span> is the spring constant and <span class="math notranslate nohighlight">\(x_i\)</span> is the value about which the
system is restrained. The potential energy function of the system is
then given by <span class="math notranslate nohighlight">\(E(\mathbf{r}^N) + w_i(x)\)</span>, such that the weight function
significantly increases the energy of any configurations with values of
the reaction coordinate that differ significantly from the restrained
value <span class="math notranslate nohighlight">\(x_i\)</span>.</p>
<p>In other words, we effectively add a fictitious force (a
spring force) that is not meant to model a physical force in the system,
but rather is added solely to force the system to sample a particular
value of the reaction coordinate. Conceptually, the idea behind this is
to effectively “flatten” the free energy landscape by forcing the system
to explore a local region near <span class="math notranslate nohighlight">\(x_i\)</span>, thus allowing the sampling of
values of <span class="math notranslate nohighlight">\(x_i\)</span> that would not be explored in an unbiased simulation.</p>
<p>We can now write the <strong>biased</strong> probability of finding the system at a
particular value of the reaction coordinate <span class="math notranslate nohighlight">\(x(\mathbf{r}^n) = x'\)</span> for
the <span class="math notranslate nohighlight">\(i\)</span>th simulation using the modified potential energy function:</p>
<div class="math notranslate nohighlight">
\[p_{\textrm{bias},i}(x') = \frac{\int d \mathbf{r}^N e^{ -\beta [E(\mathbf{r}^N)+w_i(x)]} \delta(x(\mathbf{r}^N) - x')}{\int d \mathbf{r}^N  e^{ -\beta [E(\mathbf{r}^N)+w_i(x)]} }\]</div>
<p>The delta function selects only values of <span class="math notranslate nohighlight">\(x(\mathbf{r}^N) = x'\)</span>, so if
<span class="math notranslate nohighlight">\(x' \approx x_i\)</span>, then <span class="math notranslate nohighlight">\(p_{\textrm{bias},i}(x')\)</span> will be large;
otherwise, the weight function will lead to large values of the total
energy and thus negligible values of <span class="math notranslate nohighlight">\(p_{\textrm{bias},i}(x')\)</span>. We can
sample this probability distribution directly in a simulation by adding
the weight function to the system dynamics (<em>i.e.</em>, adding a spring
force to relevant particles) to increase sampling of the value <span class="math notranslate nohighlight">\(x'=x_i\)</span>.
However, we need to sample the <strong>unbiased</strong> probability to calculate the
potential of mean force, so we need to relate <span class="math notranslate nohighlight">\(p_{\textrm{bias},i}(x')\)</span>
to <span class="math notranslate nohighlight">\(p(x')\)</span>. Relating the biased probability distribution to the unbiased
probability distribution will be the focus of the <a class="reference internal" href="Lecture15.html"><span class="doc std std-doc">next lecture</span></a>.</p>
</section>
<section id="relating-the-biased-probability-distribution-to-the-unbiased-one">
<h2>Relating the biased probability distribution to the unbiased one<a class="headerlink" href="#relating-the-biased-probability-distribution-to-the-unbiased-one" title="Permalink to this headline">#</a></h2>
<p>We showed how to write the <strong>biased</strong> probability of finding the system at a
particular value of the reaction coordinate <span class="math notranslate nohighlight">\(x(\mathbf{r}^N) = x'\)</span> for
the <span class="math notranslate nohighlight">\(i\)</span>th simulation using the modified potential energy function:</p>
<div class="math notranslate nohighlight">
\[p_{\textrm{bias},i}(x') = \frac{\int d \mathbf{r}^N e^{ -\beta [E(\mathbf{r}^N)+w_i(x)]} \delta(x(\mathbf{r}^N) - x')}{\int d \mathbf{r}^N  e^{ -\beta [E(\mathbf{r}^N)+w_i(x)]} }\]</div>
<p>The delta function selects only values of <span class="math notranslate nohighlight">\(x(\mathbf{r}^N) = x'\)</span>, so if
<span class="math notranslate nohighlight">\(x' \approx x_i\)</span>, then <span class="math notranslate nohighlight">\(p_{\textrm{bias},i}(x')\)</span> will be large;
otherwise, the weight function will lead to large values of the total
energy and thus negligible values of <span class="math notranslate nohighlight">\(p_{\textrm{bias},i}(x')\)</span>. We can
sample this probability distribution directly in a simulation by adding
the weight function to the system dynamics (<em>i.e.</em>, adding a spring
force to relevant particles) to increase sampling of the value <span class="math notranslate nohighlight">\(x'=x_i\)</span>.
However, we need to sample the <strong>unbiased</strong> probability to calculate the
potential of mean force, so we need to relate <span class="math notranslate nohighlight">\(p_{\textrm{bias},i}(x')\)</span>
to <span class="math notranslate nohighlight">\(p(x')\)</span>. To do so, we can first rewrite the biased probability
distribution as:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
p_{\textrm{bias},i}(x') &amp;= \frac{\int d \mathbf{r}^N e^{ -\beta [E(\mathbf{r}^N)]}e^{-\beta w_i(x)} \delta(x(\mathbf{r}^N) - x')}{\int d \mathbf{r}^N  e^{ -\beta [E(\mathbf{r}^N)]}e^{-\beta w_i(x)} } \\
&amp;= \frac{\int d \mathbf{r}^N e^{ -\beta [E(\mathbf{r}^N)]}e^{-\beta w_i(x)} \delta(x(\mathbf{r}^N) - x')}{Z} \frac{Z} {\int d \mathbf{r}^N  e^{ -\beta [E(\mathbf{r}^N)]}e^{-\beta w_i(x)} }
\end{aligned}\end{split}\]</div>
<p>By inspecting the second term we see that it is an integral over all
phase space of <span class="math notranslate nohighlight">\(e^{-\beta w_i(x)}\)</span> multiplied by a Boltzmann weight;
this is exactly the expression for the ensemble average
<span class="math notranslate nohighlight">\(\langle e^{-\beta w_i(x)} \rangle\)</span>, so we simplify to:</p>
<div class="math notranslate nohighlight">
\[\begin{aligned}
p_{\textrm{bias},i}(x') &amp;= \frac{\int d \mathbf{r}^N e^{ -\beta [E(\mathbf{r}^N)]}e^{-\beta w_i(x)} \delta(x(\mathbf{r}^N) - x')}{Z} \langle e^{-\beta w_i(x)} \rangle^{-1}
\end{aligned}\]</div>
<p>Next, we can recognize that the delta function in the integral selects
only those states for which <span class="math notranslate nohighlight">\(x(\mathbf{r}^N) = x'\)</span> (unlike the previous
ensemble average, where the integral includes all values of
<span class="math notranslate nohighlight">\(\mathbf{r}^N\)</span> and thus all values of <span class="math notranslate nohighlight">\(x(\mathbf{r}^N)\)</span>). As a result,
the value of the weight function can set to <span class="math notranslate nohighlight">\(e^{-\beta w_i(x')}\)</span> and
removed from the integral, yielding:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
p_{\textrm{bias},i}(x') &amp;= \frac{e^{-\beta w_i(x')}\int d \mathbf{r}^N e^{ -\beta [E(\mathbf{r}^N)]} \delta(x(\mathbf{r}^N) - x')}{Z} \langle e^{-\beta w_i(x)} \rangle^{-1}\\
&amp;= e^{-\beta w_i(x')} p(x') \langle e^{-\beta w_i(x)} \rangle^{-1}
\end{aligned}\end{split}\]</div>
<p>Note that we are being careful to distinguish between the value of the
weight function for a specific value of the reaction coordinate,
<span class="math notranslate nohighlight">\(e^{-\beta w_i(x')}\)</span>, which is analytically defined, and the
ensemble-average value of the weight function for all possible values of
the reaction coordinate, <span class="math notranslate nohighlight">\(\langle e^{-\beta w_i(x)} \rangle\)</span>, which will
depend on the entire phase space. We can then rearrange this expression
for the unbiased probability to write:</p>
<div class="math notranslate nohighlight">
\[\label{app_a_us_unbiased_prob}
p(x') = e^{\beta w_i(x')} p_{\textrm{bias}, i}(x') \langle e^{-\beta w_i(x)} \rangle\]</div>
<p>This expression thus relates the biased probability distribution from
the <span class="math notranslate nohighlight">\(i\)</span>th biased simulation to the unbiased probability distribution. We
can then write the value of the PMF, <span class="math notranslate nohighlight">\(F_i(x')\)</span> associated with <span class="math notranslate nohighlight">\(x'\)</span>
based on the <span class="math notranslate nohighlight">\(i\)</span>th simulation (i.e., the simulation with a bias applied
to <span class="math notranslate nohighlight">\(x_i\)</span>) as:</p>
<div class="math notranslate nohighlight" id="equation-app-a-us-nofi-eq">
<span class="eqno">(27)<a class="headerlink" href="#equation-app-a-us-nofi-eq" title="Permalink to this equation">#</a></span>\[\begin{split}F_i(x') &amp;= -k_BT \ln \left [ p(x') \right ] - k_BT \ln Z \\ 
&amp;= -k_BT \ln \left [   e^{\beta w_i(x')} p_{\textrm{bias}, i}(x') \langle e^{-\beta w_i(x)} \rangle \right ] - k_BT \ln Z\\
&amp;= \textcolor{red}{-k_BT \ln \left [p_{\textrm{bias}, i}(x') \right ]} -
\textcolor{orange}{w_i(x')}
\textcolor{green}{-k_BT \ln \langle \exp \left [ -\beta w_i(x) \right ] \rangle}
\textcolor{blue}{-k_BT \ln Z}\end{split}\]</div>
<p>Let’s consider each of these terms in turn.</p>
<p>The first term,
<span class="math notranslate nohighlight">\(\textcolor{red}{-k_BT \ln \left [p_{\textrm{bias}, i}(x') \right ]}\)</span>, can be estimated
directly from the <span class="math notranslate nohighlight">\(i\)</span>th biased molecular simulation for which the weight
function will restrain the simulation to sample configurations with
<span class="math notranslate nohighlight">\(x(\mathbf{r}^N) \approx x_i'\)</span>, allowing <span class="math notranslate nohighlight">\(p_{\textrm{bias}, i}(x')\)</span> to
be calculated even if <span class="math notranslate nohighlight">\(x'\)</span> is normally not sampled in an unbiased
simulation.
The second term, <span class="math notranslate nohighlight">\(\textcolor{orange}{w_i(x')}\)</span>, is calculated analytically since
the expression for the weight function is specified.
The fourth term,
<span class="math notranslate nohighlight">\(\textcolor{blue}{-k_BT \ln Z}\)</span>, is a constant that does not depend on <span class="math notranslate nohighlight">\(x'\)</span> and can be
eliminated by only consider differences in the PMF.
The third
term, <span class="math notranslate nohighlight">\(\textcolor{green}{- k_BT \ln \langle \exp \left [ -\beta w_i(x) \right ] \rangle}\)</span>
is the ensemble average of the exponential weight function for <span class="math notranslate nohighlight">\(x'\)</span>
sampled from the unbiased ensemble. As we will show below, this term is
equal to the free energy cost associated with introducing the weight
function.</p>
<p>We can define this term as <span class="math notranslate nohighlight">\(\textcolor{green}{K_i=- k_BT \ln \langle \exp \left [ -\beta w_i(x) \right ] \rangle}\)</span> to write our final expression
as:</p>
<div class="math notranslate nohighlight">
\[\label{app_a_pmf_final_eq}
F_i(x') = -k_BT \ln \left [p_{\textrm{bias}, i}(x') \right ] - w_i(x') +     K_i  - k_BT \ln Z\]</div>
<p>This final expression is a powerful approach for computing values of the
PMF as follows. We first define a set of harmonic weight functions, each
centered on some value <span class="math notranslate nohighlight">\(x_i\)</span> such that the total set of restrained
values spans the values of <span class="math notranslate nohighlight">\(x\)</span> that are of interest. An independent
simulation is then performed for each value of <span class="math notranslate nohighlight">\(x_i\)</span> and
<span class="math notranslate nohighlight">\(p_{\textrm{bias}, i}(x')\)</span> is estimated for all <span class="math notranslate nohighlight">\(x'\)</span> (typically by
histogramming). The unbiased PMF for <span class="math notranslate nohighlight">\(x'\)</span> is then computed from the
<span class="math notranslate nohighlight">\(i\)</span>th simulation using the expression above. By only considering
differences in the PMF, the <span class="math notranslate nohighlight">\(- k_BT \ln Z\)</span> term drops out, leaving only
the set of <span class="math notranslate nohighlight">\(K_i\)</span> to be determined for the entire PMF to be specified.
However, we can compute the set of <span class="math notranslate nohighlight">\(K_i\)</span> by recognizing that the value
of the unbiased PMF, <span class="math notranslate nohighlight">\(F_i(x')\)</span>, should be independent of the value of
<span class="math notranslate nohighlight">\(x_i\)</span> that is biased. Thus, we can compute <span class="math notranslate nohighlight">\(F_i(x')\)</span> for the same <span class="math notranslate nohighlight">\(x'\)</span>
from several different biased simulations (i.e. different biased values
of <span class="math notranslate nohighlight">\(x_i\)</span>) and adjust the values of <span class="math notranslate nohighlight">\(K_i\)</span> such that the estimate for
<span class="math notranslate nohighlight">\(F(x')\)</span> matches across all biased windows. This approach requires that
the biased simulations <strong>overlap</strong> - that is, that there is a
non-negligible value of <span class="math notranslate nohighlight">\(p_{\textrm{bias}, i}(x')\)</span> for the same value of
<span class="math notranslate nohighlight">\(x'\)</span> sampled in each of the overlapping windows. In practice, this means
that the harmonic weight function must allow the system to sample
configurations slightly different from <span class="math notranslate nohighlight">\(x_i\)</span> to ensure that <span class="math notranslate nohighlight">\(x'\)</span> can be
sampled in multiple different biased simulations.</p>
<p><img alt="image" src="../_images/fig_15_1-01.png" /></p>
<p>So, to recap: umbrella sampling allows us to calculate the PMF (i.e. the
change in the free energy) associated with any arbitrary process by
sampling configurations associated with different values of a reaction
coordinate associated with the process. The key advantage of the
umbrella sampling approach is that any value of the reaction coordiante
can be sampled by applying weight functions, thus enabling the estimate
of the PMF even for very low probability (high free energy) states. From
a computational standpoint, this method requires a series of independent
simulations to be performed and then free energies to be determined by
matching estimates of the PMF from overlapping biased simulations. The
requirement of overlap renders this technique inefficient
computationally, although more efficient methods (such as the Weighted
Histogram Analysis Method) have been developed to compute the set of
<span class="math notranslate nohighlight">\(K_i\)</span>. These techniques are outside the scope of this discussion.
Umbrella sampling is very commonly used to compute PMFs for processes
with large energy barriers, such that the processes cannot be directly
observed in unbiased simulations. For example, one could apply umbrella
sampling to calculate the free energy change associated with adsorbing a
molecule to a surface by defining the distance to the surface as the
reaction coordinate, choosing multiple values of this distance, then
performing multiple independent simulations in which the molecule of
interest is restrained to each value of the reaction coordinate using a
harmonic spring.</p>
</section>
<section id="link-to-shared-notes">
<h2><a class="reference external" href="https://docs.google.com/document/d/1G7nxHKyv8UlBFkqbUdrUbfERmWQ9XRh8/edit?usp=drive_link&amp;ouid=113272049620170441297&amp;rtpof=true&amp;sd=true">Link to Shared Notes</a><a class="headerlink" href="#link-to-shared-notes" title="Permalink to this headline">#</a></h2>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./lecture_files"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="Lecture14A.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">The potential of mean force</p>
      </div>
    </a>
    <a class="right-next"
       href="Lecture15.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Free energy perturbation and thermodynamic integration</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-readings-for-the-enthusiast">Additional Readings for the Enthusiast</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#goals-for-today-s-lecture">Goals for Today’s Lecture</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">Umbrella sampling</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#relating-the-biased-probability-distribution-to-the-unbiased-one">Relating the biased probability distribution to the unbiased one</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#link-to-shared-notes">Link to Shared Notes</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Reid van Lehn, Matt Gebbie, Rose K. Cersonsky
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>